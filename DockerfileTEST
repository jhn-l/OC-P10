# ðŸ”¹ Ã‰tape 1 : Image de base pour lâ€™installation des dÃ©pendances
FROM python:3.12 AS build

# DÃ©finir un rÃ©pertoire de travail
ARG FUNCTION_DIR="/function"
RUN mkdir -p ${FUNCTION_DIR}
WORKDIR ${FUNCTION_DIR}

# âœ… Installer les outils de compilation nÃ©cessaires
RUN apt-get update && apt-get install -y \
    gcc g++ make libstdc++-12-dev libstdc++-11-dev libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# âœ… Copier et installer les dÃ©pendances (y compris Surprise, scikit-learn et boto3)
COPY requirements.txt .
RUN pip install --no-cache-dir --target ${FUNCTION_DIR} -r requirements.txt boto3 scikit-learn surprise numpy pandas

# ðŸ”¹ Ã‰tape 2 : EntraÃ®nement du modÃ¨le
FROM build AS train
WORKDIR /function

# âœ… DÃ©finir le chemin du modÃ¨le
ENV MODEL_PATH=/tmp/recommender_model_hybrid.pkl
ENV SURPRISE_DATASET_DIR="/tmp"

# âœ… Copier le script d'entraÃ®nement
COPY train.py .

# âœ… Passer les credentials AWS via des arguments de build
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_REGION

# âœ… DÃ©finir les variables d'environnement pour `boto3`
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_REGION=${AWS_REGION}

# âœ… VÃ©rifier les valeurs des variables dâ€™environnement (debug)
RUN echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" && \
    echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" && \
    echo "AWS_REGION=$AWS_REGION"

# âœ… ExÃ©cuter l'entraÃ®nement du modÃ¨le
RUN python3 train.py

# ðŸ”¹ Ã‰tape 3 : Image finale pour AWS Lambda
FROM python:3.12-slim AS final
ARG FUNCTION_DIR="/function"
WORKDIR ${FUNCTION_DIR}

# âœ… Copier uniquement les dÃ©pendances prÃ©installÃ©es
COPY --from=build ${FUNCTION_DIR} ${FUNCTION_DIR}

# âœ… Copier le modÃ¨le entraÃ®nÃ© depuis lâ€™Ã©tape `train`
COPY --from=train /tmp/recommender_model_hybrid.pkl ${FUNCTION_DIR}/recommender_model_hybrid.pkl

# âœ… Copier le fichier de recommandation (Lambda handler)
COPY hybrid_recommender.py .

# âœ… DÃ©finir le Runtime Interface Client pour AWS Lambda
ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]
CMD ["hybrid_recommender.lambda_handler"]
